Prerequisites
=============
# java, maven, git
apt-get install -y default-jdk git-all maven curl

# docker, docker-compose on Ubuntu 16
apt-get install -y docker docker-compose

# docker engine Ubuntu 14
apt-get update
sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
echo "deb https://apt.dockerproject.org/repo ubuntu-trusty main" | sudo tee /etc/apt/sources.list.d/docker.list
apt-get install apt-transport-https
apt-get update
apt-cache policy docker-engine
apt-get install linux-image-extra-$(uname -r) linux-image-extra-virtual
apt-get install docker-engine
service docker status
# docker-compose Ubuntu 14
curl -L "https://github.com/docker/compose/releases/download/1.8.1/docker-compose-$(uname -s)-$(uname -m)" > /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

1. Build war files
===================
git clone https://github.com/entice-repository/wp3-image-synthesis.git
cd wp3-image-synthesis
git checkout -b develop origin/develop
cd ..

mvn install -Dmaven.test.skip=true -f wp3-image-synthesis/image-fragmentation-service/pom.xml
mvn install -Dmaven.test.skip=true -f wp3-image-synthesis/image-optimizer-service/pom.xml

2. Unpack docker-compose archive
================================
tar -xvf wp3-image-synthesis/image-fragmentation-service/image-synthesis-docker-compose.tar.gz

3. Copy war files
=================
cp wp3-image-synthesis/image-fragmentation-service/installer-storage/target/installer-storage.war image-synthesis-docker-compose/tomcat/webapps/
cp wp3-image-synthesis/image-fragmentation-service/virtual-image-composer/target/virtual-image-composer.war image-synthesis-docker-compose/tomcat/webapps/
cp wp3-image-synthesis/image-fragmentation-service/virtual-image-decomposer/target/virtual-image-decomposer.war image-synthesis-docker-compose/tomcat/webapps/
cp wp3-image-synthesis/image-fragmentation-service/virtual-image-launcher/target/virtual-image-launcher.war image-synthesis-docker-compose/tomcat/webapps/
cp wp3-image-synthesis/image-fragmentation-service/virtual-image-manager/target/virtual-image-manager.war image-synthesis-docker-compose/tomcat/webapps/
cp wp3-image-synthesis/image-optimizer-service/target/image-optimizer-service.war image-synthesis-docker-compose/tomcat/webapps/

4. Create Virtual Image Decomposer VM
=====================================
On a separate host, install tomcat and necessary tools
  apt-get install -y tomcat7
  apt-get install -y curl unzip sudo module-init-tools python-pip python-dev qemu
If fragments will be stored on S3, install AWS CLI
  curl https://s3.amazonaws.com/aws-cli/awscli-bundle.zip -o awscli-bundle.zip
  unzip awscli-bundle.zip
  ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws
  pip install --upgrade pip
  pip install awscli
Create these directories with chown tomcat7:tomcat7:
  mkdir /mnt/decomposer
  chown tomcat7:tomcat7 /mnt/decomposer  
Make tomcat7 sudoer:
  sudo adduser tomcat7 sudo
  echo 'tomcat7 ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers  
  
# vi /usr/share/tomcat7/bin/setenv.sh
#!/bin/sh
export FRAGMENT_STORAGE_URL=http://<fragement-storage-host>:8080/fragment-storage/rest/fragments
export FRAGMENT_STORAGE_PATH=/mnt/fragments
export FRAGMENT_STORAGE_TOKEN=entice
export VIRTUAL_IMAGE_COMPOSER_REST_URL=http://<virtual-image-manager-host>:8080/virtual-image-composer/rest
export INSTALLER_STORAGE_URL=http://<virtual-image-manager-host>:8080/installer-storage/rest
  
Deploy: virtual-image-decomposer.war
git clone https://github.com/entice-repository/wp3-image-synthesis.git
cd wp3-image-synthesis
git checkout -b develop origin/develop
cd ..
mvn install -Dmaven.test.skip=true -f wp3-image-synthesis/image-fragmentation-service/pom.xml
cp wp3-image-synthesis/image-fragmentation-service/virtual-image-decomposer/target/virtual-image-decomposer.war /var/lib/tomcat7/webapps/

5. Configure services
=====================
vi image-synthesis-docker-compose/env-docker-compose
PUBLIC_VIRTUAL_IMAGE_COMPOSER_REST_URL=http://<virtual-image-manager-host>:8080/virtual-image-composer/rest
VIRTUAL_IMAGE_DECOMPOSER_REST_URL=http://<virtual-image-decomposer-host>:8080/virtual-image-decomposer/rest

6. Start
========

NOTE: change in docker-compose.yml: image: mysql:5.7

docker-compose create
docker-compose start

7. Test
========
wget http://localhost:8080/virtual-image-manager/
wget http://localhost:8080/image-optimizer-service/

